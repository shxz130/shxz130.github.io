---
layout : life
title : "深入理解Java之线程之同步器/Semaphore/barrier/CountDownLatch/exchange"
category : 深入理解Java
duoshuo: true
date : 2014-11-19
---

##同步器

-----------

* Semaphore(信号量)
 * 以同步的方式实现n个线程同时执行,当只是一维信号量(1个线程同时执行),这个时候,信号量可以作为互斥来使用。
 * 常用类：**Semaphore**
	* acquire():void 获得信号量
	* release():void 释放信号量
* Barrier(屏障)
 * 主要是使用屏障点来阻塞所有的线程,当所有的线程没有达到屏障点的时候会等待所有的线程执行完才做其他的事情.
 * 常用类：**CyclicBarrier**
	* void await():处于等待状态，等待所有线程到达屏障点。等到所有线程都达到屏障点就开始运行。
* CountDownLatch
 * 提供一个计数器,当计数器为0的时候,所有的线程才释放资源。
* exchange(交换器)

----------

###信号量测试代码

------------

{% highlight java %}
package com.shxz.thread;

import java.util.concurrent.Semaphore;

public class Mycar {
	private boolean isFull=false;
	private Semaphore sem=new Semaphore(1);
	//设置信号量为一维
	public void put(){
		if(!isFull){
			try {
				sem.acquire();//申请到信号量
				System.out.println("my car is null, i put a goods");
				isFull=true;
				sem.release();//释放信号量
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				
				e.printStackTrace();
			}
		}
	}
	public void get(){
		if(isFull){
			try {
				sem.acquire();//申请到信号量
				System.out.println("fetch goods, my car is null");
				isFull=false;
				sem.release();//释放信号量
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
	}

}
{% endhighlight %}
------------
{% highlight java %}
package com.shxz.thread;

public class GetThread implements Runnable{
	Mycar mycar;
	
	public GetThread(Mycar mycar)
	{
		
		this.mycar=mycar;
		
	}

	@Override
	public void run() {
		// TODO Auto-generated method stub
		while(true){
		mycar.get();
		}
	}
}

{% endhighlight %}
------------
{% highlight java %}
package com.shxz.thread;

public class PutThread implements Runnable{

	Mycar mycar;
	
	public PutThread(Mycar mycar){
		this.mycar=mycar;
	}
	@Override
	public void run() {
		// TODO Auto-generated method stub
		while(true){
		mycar.put();
		}
	}

}

{% endhighlight %}
------------
{% highlight java %}
public static void main(String[] args) {
		Mycar car=new Mycar();
		GetThread getThread=new GetThread(car);
		PutThread putThread=new PutThread(car);
		new Thread(putThread).start();
		new Thread(getThread).start();
	}
{% endhighlight %}
------------
{% highlight java %}
public static void main(String[] args) {
		Mycar car=new Mycar();
		GetThread getThread=new GetThread(car);
		PutThread putThread=new PutThread(car);
		new Thread(putThread).start();
		new Thread(getThread).start();
	}
{% endhighlight %}
------------

###运行结果：

------------

>my car is null, i put a goods
>fetch goods, my car is null
>my car is null, i put a goods
>fetch goods, my car is null
>my car is null, i put a goods

------------

##屏障源代码

-------------
{% highlight java %}
package com.shxz.barrier;

import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CyclicBarrier;

public class CityThread implements Runnable{

	private Counter counter;
	private String city;
	private CyclicBarrier barrier;
	
	public CityThread(String city, CyclicBarrier cyclicBarrier, Counter counter){
		this.counter=counter;
		this.city=city;
		this.barrier=cyclicBarrier;
	}
	@Override
	public void run() {
		// TODO Auto-generated method stub
		this.counter.CityCount();
		try {
			this.barrier.await();//处于等待状态。
		} catch (InterruptedException | BrokenBarrierException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}//等待其他线程
	}
}
{% endhighlight %}
------------
{% highlight java %}
package com.shxz.barrier;

import java.util.concurrent.CyclicBarrier;

public class Counter {
	public void TotalCount(){
		System.out.println("count all cities population");
	}
	public void CityCount(){
		System.out.println("count the city population");
	}
	

}

{% endhighlight %}
------------
{% highlight java %}
package com.shxz.barrier;


public class TotalThread implements Runnable{
	private Counter counter;
	public TotalThread(Counter counter)
	{
		this.counter=counter;
	}
	@Override
	public void run() {
		// TODO Auto-generated method stub
		this.counter.TotalCount();
	}
}

{% endhighlight %}
------------
{% highlight java %}
	public static void main(String[] args) {
		Counter counter=new Counter();
		CyclicBarrier cyclicBarrier=new CyclicBarrier(4,new TotalThread(counter));
		
		new Thread(new CityThread("陕西",cyclicBarrier,counter)).start();
		new Thread(new CityThread("广东",cyclicBarrier,counter)).start();
		new Thread(new CityThread("福建",cyclicBarrier,counter)).start();
		new Thread(new CityThread("山西",cyclicBarrier,counter)).start();
	}
{% endhighlight %}
------------

###运行结果：

------------

>count the city population
>count the city population
>count the city population
>count the city population
>count all cities population

------------
